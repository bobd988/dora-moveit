# GEN72 Multi-View Capture + Planning + MuJoCo Visualization
# ==========================================================
# 从 GEN72 多视角拍照需求出发，串起：
#   - 多视角控制（capture）
#   - IK 求解（ik_solver）
#   - 带碰撞检测的轨迹规划（planner）
#   - 轨迹执行（trajectory_executor）
#   - MuJoCo 仿真可视化（mujoco_sim）
#
# 运行方法：
#   dora start dataflow_gen72_mujoco.yml

nodes:
  # ===========================================
  # MuJoCo 仿真（Panda 机器人，用来可视化）
  # ===========================================
  - id: mujoco_sim
    path: dora-mujoco
    inputs:
      tick: dora/timer/millis/10         # 100 Hz 仿真
      control_input: trajectory_executor/joint_commands
    outputs:
      - joint_positions                  # 当前关节角（用于场景、IK、执行器）
      - joint_velocities
      - sensor_data
    env:
      MODEL_NAME: "F:/2-DORA/2-arm/dora-moveit/dora-moveit/config/GEN72_base.xml"

  # ===========================================
  # Planning Scene 管理器（统一场景）
  # ===========================================
  - id: planning_scene
    path: ../motion_planner/planning_scene_op.py
    inputs:
      robot_state: mujoco_sim/joint_positions     # 用仿真关节值更新场景中的机器人状态
      scene_command: capture/scene_command        # 来自多视角控制器的场景指令（如添加障碍物等）
      tick: dora/timer/millis/5000                # 周期性广播场景
    outputs:
      - scene_update                              # 广播场景更新给 planner 等
      - command_result                            # 场景命令执行结果

  # ===========================================
  # OMPL Motion Planner（内置碰撞检测）
  # ===========================================
  - id: planner
    path: ../motion_planner/planner_ompl_with_collision_op.py
    inputs:
      plan_request: capture/plan_request          # 多视角控制器发出的规划请求（start / goal 关节）
      scene_update: planning_scene/scene_update   # 使用统一场景进行碰撞检测
    outputs:
      - trajectory                                # 规划出的关节轨迹
      - plan_status                               # 规划状态（成功/失败等）

  # ===========================================
  # IK Solver（GEN72 的逆向运动学）
  # ===========================================
  - id: ik_solver
    path: ../ik_solver/ik_op.py
    inputs:
      ik_request: capture/ik_request              # 多视角控制器发出的末端位姿请求
      #joint_state: mujoco_sim/joint_positions     # 当前关节作为 IK 初始迭代种子
    outputs:
      - ik_solution                               # 关节解
      - ik_status                                 # IK 求解状态

  # ===========================================
  # 轨迹执行器（把 planner 轨迹发给 MuJoCo）
  # ===========================================
  - id: trajectory_executor
    path: ../trajectory_execution/trajectory_executor.py
    inputs:
      trajectory: planner/trajectory              # 规划出的轨迹
      joint_positions: mujoco_sim/joint_positions# 用仿真当前位姿做插值参考
      tick: dora/timer/millis/50                  # 20 Hz 执行节拍
    outputs:
      - joint_commands                            # 发送给 MuJoCo 的关节指令
      - execution_status                          # 执行状态（是否在执行、当前时间等）

  # ===========================================
  # GEN72 多视角拍照控制器（任务入口）
  # ===========================================
  - id: capture
    path: ../workflow/multi_view_capture_node.py
    env:
      capture_output_dir: "../result_captures"

    inputs:
      joint_positions: mujoco_sim/joint_positions # 实时关节位置
      execution_status: trajectory_executor/execution_status # 轨迹执行状态
      trajectory: planner/trajectory              # 用来更新当前关节、决定下一视角
      plan_status: planner/plan_status            # 了解规划是否成功，失败则尝试附近位姿
      ik_solution: ik_solver/ik_solution          # IK 输出的关节解（交给 planner 做 goal）
      ik_status: ik_solver/ik_status              # IK 成功/失败信息
    outputs:
      - robot_state                               # 当前认为的关节状态（目前未接入，可保留）
      - plan_request                              # 发给 planner 的规划请求（start / goal）
      - ik_request                                # 发给 ik_solver 的末端位姿
      - scene_command                             # 发给 planning_scene 的场景命令（可扩展）
