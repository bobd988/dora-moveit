# Dora-MoveIt + MuJoCo Integration
# =================================
# Tests the motion planner with MuJoCo Panda robot simulation
#
# Run: dora start dataflow_mujoco.yml

nodes:
  # ===========================================
  # MuJoCo Simulator (Panda Robot)
  # ===========================================
  - id: mujoco_sim
    build: pip install -e ../../../node-hub/dora-mujoco
    path: dora-mujoco
    inputs:
      tick: dora/timer/millis/10  # 100 Hz simulation
      control_input: trajectory_executor/joint_commands
    outputs:
      - joint_positions
      - joint_velocities
      - sensor_data
    env:
      MODEL_NAME: "panda_mj_description"  # Franka Panda robot

  # ===========================================
  # Planning Scene Manager
  # ===========================================
  - id: planning_scene
    path: planning_scene_op.py
    inputs:
      robot_state: mujoco_sim/joint_positions
      scene_command: motion_commander/scene_command
      tick: dora/timer/millis/5000
    outputs:
      - scene_update
      - command_result

  # ===========================================
  # OMPL Motion Planner
  # ===========================================
  - id: planner
    path: planner_ompl_with_collision_op.py
    inputs:
      plan_request: motion_commander/plan_request
      scene_update: planning_scene/scene_update
    outputs:
      - trajectory
      - plan_status

  # ===========================================
  # IK Solver
  # ===========================================
  - id: ik_solver
    path: ik_op.py
    inputs:
      ik_request: motion_commander/ik_request
      joint_state: mujoco_sim/joint_positions
    outputs:
      - ik_solution
      - ik_status

  # ===========================================
  # Trajectory Executor
  # ===========================================
  # Executes planned trajectories on the robot
  - id: trajectory_executor
    path: trajectory_executor.py
    inputs:
      trajectory: planner/trajectory
      joint_positions: mujoco_sim/joint_positions
      tick: dora/timer/millis/50  # 20 Hz execution
    outputs:
      - joint_commands
      - execution_status

  # ===========================================
  # Motion Commander (Test Interface)
  # ===========================================
  - id: motion_commander
    path: motion_commander.py
    inputs:
      tick: dora/timer/millis/3000  # Slow tick for demo
      plan_status: planner/plan_status
      ik_status: ik_solver/ik_status
      execution_status: trajectory_executor/execution_status
      joint_positions: mujoco_sim/joint_positions
    outputs:
      - plan_request
      - ik_request
      - scene_command

